rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ==== Helpers básicos ====

    function isAuthenticated() {
      return request.auth != null;
    }

    // El doc YA almacenado pertenece al usuario actual
    function isResourceOwner() {
      return isAuthenticated()
             && resource.data.userId is path
             && resource.data.userId.id == request.auth.uid;
    }

    // El doc NUEVO/actualizado pertenece al usuario actual
    function isRequestOwner() {
      return isAuthenticated()
             && request.resource.data.userId is path
             && request.resource.data.userId.id == request.auth.uid;
    }

    // ==== USERS (igual que antes) ====

    match /users/{userId} {
      allow read, create, update: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if false;
    }

    // ==== SOLO categories con reglas estrictas ====

    match /categories/{categoryId} {
      allow read: if isAuthenticated()
        && resource.data.userId is path
        && resource.data.userId.id == request.auth.uid;

      allow create: if isAuthenticated()
        && request.resource.data.userId is path
        && request.resource.data.userId.id == request.auth.uid;

      allow update: if isAuthenticated()
        && resource.data.userId is path
        && resource.data.userId.id == request.auth.uid
        && request.resource.data.userId is path
        && request.resource.data.userId.id == request.auth.uid;

      allow delete: if isAuthenticated()
        && resource.data.userId is path
        && resource.data.userId.id == request.auth.uid;
    }


    // ==== TODO LO DEMÁS (income, expenses, etc.) abierto mientras depuramos ====

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
